# CJF.Schedule 測試專案說明文件

## 概述

本測試專案 `CJF.Schedule.Test` 是針對 `CJF.Schedule` 排程系統的測試套件，使用 xUnit 測試框架進行功能驗證。本專案測試所有可公開存取的 API，確保排程系統的核心功能正常運作。

## 測試架構

### 技術棧
- **.NET 8.0**: 目標框架
- **xUnit**: 主要測試框架
- **Moq**: 模擬物件框架
- **Microsoft.Extensions.DependencyInjection**: 依賴注入容器
- **Microsoft.Extensions.Hosting**: 主機服務支援
- **Microsoft.Extensions.Logging**: 日誌記錄

### 專案結構
```
CJF.Schedule.Test/
├── CJF.Schedule.Test.csproj         # 專案檔案
├── BasicFunctionalTests.cs          # 基本功能測試
├── PublicApiTests.cs                # 公共 API 測試
├── AttributeAndEnumTests.cs         # 屬性和列舉測試
└── 測試說明文件.md                    # 本文件
```

## 測試類別詳細說明

### 1. BasicFunctionalTests.cs
基本功能測試，驗證核心功能的正確性：
- **SchedulePlan 建立**: 測試排程計畫的基本建立和屬性設定
- **排程類型**: 驗證不同排程表達式對應的排程類型
- **時間計畫功能**: 測試 ITimePlan 介面的描述和表達式功能
- **配置選項**: 驗證 ScheduleWorkerOptions 的預設值
- **例外類別**: 測試 KeyExistsException 和 ExceptionEventArgs
- **列舉驗證**: 驗證 PlanTypes 和 WeekDays 等列舉的正確性
- **錯誤處理**: 測試無效排程表達式的例外處理

**主要測試案例**:
- 基本排程建立和屬性驗證
- 不同排程類型（Startup、Stoped、Once、Day）的建立
- 時間計畫的描述和表達式生成
- 旗標列舉的操作驗證
- 無效輸入的例外處理

### 2. PublicApiTests.cs
公共 API 測試，專注於測試可公開存取的介面：
- **SchedulePlan 建構**: 測試 Action 和 Action<ISchedulePlan> 兩種建構方式
- **SchedulePlanWorker**: 測試排程工作器的基本操作
- **排程集合管理**: 測試透過 SchedulePlanWorker 進行的排程管理
- **主機服務**: 測試 SchedulePlanWorkerHostedService 的功能
- **生命週期管理**: 測試啟動和停止功能

**主要測試案例**:
- 排程的新增、移除和查詢
- 排程集合的篩選和列舉
- 主機服務的建立和配置
- 異步生命週期管理

### 3. AttributeAndEnumTests.cs
屬性和列舉測試，驗證系統的輔助類別：
- **SchedulePlanAttribute**: 測試排程屬性的各種建構函式
- **列舉驗證**: 驗證所有列舉類型的值和旗標操作
- **屬性設定**: 驗證 AttributeUsage 的正確配置
- **描述功能**: 測試列舉的描述屬性
- **例外處理**: 測試自訂例外類別的功能

**主要測試案例**:
- 各種排程屬性建構函式的參數驗證
- 列舉值的正確性驗證
- 旗標列舉的組合操作
- 無效時間字串的例外處理
- 自訂例外類別的屬性驗證

## 測試執行

### 執行所有測試
```bash
dotnet test
```

### 執行特定測試類別
```bash
dotnet test --filter "ClassName=TimePlanTests"
```

### 產生測試報告
```bash
dotnet test --logger "trx;LogFileName=TestResults.trx"
```

### 程式碼覆蓋率
```bash
dotnet test --collect:"XPlat Code Coverage"
```

## 測試資料和模式

### 測試資料
- **日期時間**: 使用固定日期 2023-01-01 以確保測試的一致性
- **排程表達式**: 涵蓋所有排程類型的表達式
- **錯誤情境**: 包含各種異常和邊界條件

### 測試模式
- **AAA 模式**: Arrange-Act-Assert 結構
- **單一職責**: 每個測試方法只驗證一個功能點
- **描述性命名**: 測試方法名稱清楚描述測試情境
- **參數化測試**: 使用 Theory 和 InlineData 進行多案例測試

## 持續整合

### GitHub Actions
```yaml
- name: Test
  run: dotnet test --no-build --verbosity normal --collect:"XPlat Code Coverage"
```

### 測試報告
- 單元測試結果報告
- 程式碼覆蓋率報告
- 效能基準測試

## 故障排除

### 常見問題
1. **測試超時**: 檢查非同步測試的 CancellationToken 使用
2. **資源洩漏**: 確保 IDisposable 物件正確釋放
3. **並行問題**: 注意靜態變數在並行測試中的影響

### 除錯技巧
- 使用 `Record.Exception` 捕獲例外
- 利用 `Task.Delay` 處理時序相關測試
- 使用 Mock 物件隔離依賴

## 效能考量

### 測試效能
- 使用最小延遲時間
- 避免不必要的 Thread.Sleep
- 合理使用 async/await

### 記憶體管理
- 正確實作 IDisposable
- 及時釋放資源
- 避免記憶體洩漏

## 擴充測試

### 新增測試案例
1. 建立新的測試類別
2. 繼承適當的基底類別
3. 實作 IDisposable (如需要)
4. 使用適當的測試屬性

### 測試最佳實務
- 測試應該快速執行
- 測試應該獨立運行
- 測試應該可重複執行
- 測試應該有明確的預期結果

## 結論

本測試專案提供了對 CJF.Schedule 排程系統的全面測試覆蓋，包含單元測試、整合測試和功能驗證。透過這些測試，可以確保排程系統的可靠性、穩定性和正確性。

測試涵蓋了所有主要功能模組，包括時間計畫、排程執行、集合管理、工作器邏輯和主機服務等，為系統的品質保證提供了堅實的基礎。